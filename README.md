# Population-Weighted Climate Exposure in Sweden

This repository contains scripts to compute **population-weighted means of climate variables** for Swedish administrative units (districts and parishes) using gridded climate data and population distribution grids.

## 👤 Server Setup

Before running the scripts, make sure the required modules are loaded on the HPC server:

```bash
module purge

# Environment and build tools
module load buildenv-gcc/11.3.0-bare
module load buildtool-easybuild/4.8.0-hpce082752a2
module load GCC/11.3.0

# Geospatial and climate data libraries
module load GDAL/3.5.0-hpc1-gcc-2022a-eb
module load GEOS/3.10.3
module load PROJ/9.0.0
module load netCDF-HDF5/4.9.2-1.12.2-hpc1

# R environment
module load R/4.4.0-hpc1-gcc-11.3.0-bare

# Units of measurement
module load UDUNITS/2.2.28
```

## 📦 R Package Installation

In your R session, install the required packages:

```r
install.packages("ncdf4") # Optional if using other NetCDF tools
install.packages("terra")
install.packages("sf")
install.packages("data.table")
install.packages("exactextractr")
install.packages("curl")
install.packages("dplyr")
```

## 📁 Scripts Overview

### 1. `intersection_polygons.r`

This script **intersects population grid polygons with administrative boundary polygons** (districts and parishes), computes their overlapping area, and saves the results for future weighted analysis.

* **Inputs**:

  * Population grid (GeoPackage)
  * District and parish boundaries (GeoPackages)
* **Outputs**:

  * RDS files storing intersected polygons with population and area weights

**Core functionality:**

* Uses the `terra` package for polygon intersection.
* Computes area in square meters and converts to square kilometers for weighting.
* Saves processed spatial data to RDS files.

---

### 2. `weighted_mean.r`

This script **downloads daily gridded climate data**, extracts values over administrative units, and computes **population-weighted climate means**.

* **Inputs**:

  * NetCDF climate data from SMHI (via URL)
  * Spatial population-weighted polygons (generated by `intersection_polygons.r`)
* **Outputs**:

  * CSV files with daily population-weighted climate data by district and parish

**Main steps:**

1. Generate monthly NetCDF URLs for the desired years.
2. Download the data if not already present.
3. Reproject and extract mean raster values over polygons using `exactextractr`.
4. Calculate weights using population and polygon area fraction.
5. Compute weighted means and aggregate by administrative unit.
6. Save results in a tidy format.

**Variables analyzed:**

* `tas`: air temperature
* `pr`: precipitation
* `hurs`: relative humidity
* `tasmax`: daily max temperature
* `tasmin`: daily min temperature

## 📂 Output Structure

Outputs are saved to:

```
Regridded/<VARIABLE>/no_mask/<AREA>/temp_<AREA>_<YEAR>.csv
```

Where:

* `<VARIABLE>` is one of `tas`, `pr`, etc.
* `<AREA>` is `district` or `parish`
* `<YEAR>` is the year of data

## 📌 Notes

* Ensure the spatial files are located in `vectors/` and `input_files/` directories as used in the scripts.
* For test runs, the current setup processes only the first 3 months of each year. You can remove this filter in the `run_for_area()` function.

---

## 🔗 Data Sources

* **Climate Data:** [SMHI GridClim](https://opendata-download-metanalys.smhi.se/gridclim/)
* **Population Grids:** Statistics Sweden or user-provided
* **Administrative Boundaries:** Lantmäteriet or other open GIS sources

---

## 👨‍💻 Authors & Acknowledgements

Developed as part of research on climate-health interactions using spatial epidemiology and high-resolution climate data.

---

## 📃 License

TO BE ADDED...
